<html>
  <body>
    <script src="./mqtt.min.js"></script>

    Tempo:
    <input type="text" id="time" placeholder="Tempo em segundos" value="2400" />
    <p />

    <button onclick="start()">Iniciar partida</button>

    <select id="scene" onchange="changeScene()">
      <option value="Scene0">Cena 0</option>
      <option value="Scene1">Cena 1</option>
      <option value="Scene2">Cena 2</option>
      <option value="Scene3">Cena 3</option>
      <option value="Scene4">Cena 4</option>
      <option value="Scene5">Cena 5</option>
      <option value="Scene6">Cena 6</option>
      <option value="Scene7">Cena 7</option>
      <option value="Scene8">Cena 8</option>
      <option value="Scene9">Cena 9</option>
      <option value="Scene10">Cena 10</option>
      <option value="Scene11">Cena 11</option>
      <option value="Scene12">Cena 12</option>
      <option value="Scene13">Cena 13</option>
      <option value="Scene14">Cena 14</option>
      <option value="Scene15">Cena 15</option>
    </select>

    <button onclick="stop()">Encerrar partida</button>

    <div class="center" id="mqtt-logger"></div>
    <script>
      const mqttBrokerUrl = "wss://escape-run.sj.ifsc.edu.br/mqtt"
      const client = mqtt.connect(mqttBrokerUrl)
      const logger = document.getElementById("mqtt-logger")
      let messages = []

      client.on("connect", () => {
        messages.push("Connected to MQTT broker")

        client.subscribe("escape-run/#", (err) => {
          if (!err) {
            messages.push("Subscribed to escape run topics")
          } else {
            messages.push(`Error subscribing: ${err}`)
          }

          client.on("message", (topic, message) => {
            messages.push(`${topic}: ${message.toString()}`)

            messages = messages.slice(-20)
            logger.innerHTML = messages.join("<br />")
          })
        })
      })

      function start() {
        let time = parseInt(document.getElementById("time").value)
        if (isNaN(time) || time <= 0) time = 2400

        client.publish("escape-run/server/start", time.toString())
      }

      function changeScene() {
        const scene = document.getElementById("scene").value

        client.publish("escape-run/server/scene", scene)
      }

      function stop() {
        client.publish("escape-run/server/stop", "0")
      }
    </script>
  </body>
</html>
